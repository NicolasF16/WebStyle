<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Cadastro de Usuário</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
    <div class="cadastro-container">
        <h2>Cadastro de Usuário</h2>
        <form th:action="@{/cadastro}" method="post" onsubmit="return validarFormulario()">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" required>
            
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" name="cpf" maxlength="14" required
                   placeholder="000.000.000-00" oninput="formatarValidarCPF(this)">
            <div id="cpf-status" class="cpf-status"></div>
            
            <label for="email">E-mail:</label>
            <input type="email" id="email" name="email" required>
            
            <label for="tipo">Grupo:</label>
            <select id="tipo" name="tipo" required>
                <option value="">Selecione</option>
                <option value="BACKOFFICE">Administrador</option>
                <option value="EXTERNO">Estoquista</option>
            </select>
            
            <label for="senha">Senha:</label>
            <input type="password" id="senha" name="senha" required>
            
            <label for="senha2">Confirme a Senha:</label>
            <input type="password" id="senha2" name="senha2" required>
            
            <div id="erro-senha" class="error-message" style="display:none;">
                As senhas não coincidem.
            </div>
            
            <div id="erro-cpf" class="error-message" style="display:none;">
                CPF inválido. Por favor, verifique o número digitado.
            </div>
            
            <button type="submit">Cadastrar</button>
            <button type="button" onclick="window.location.href='/usuarios'">Cancelar</button>
        </form>
        
        <!-- Mensagem de erro -->
        <div th:if="${erro}" class="error-message">
            <p th:text="${erro}"></p>
        </div>
    </div>

    <script>
        function formatarCPF(cpf) {
            // Remove todos os caracteres não numéricos
            cpf = cpf.replace(/\D/g, '');
            
            // Aplica a máscara do CPF
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            
            return cpf;
        }

        function validarCPF(cpf) {
            // Remove caracteres não numéricos
            cpf = cpf.replace(/\D/g, '');
            
            // Verifica se tem 11 dígitos
            if (cpf.length !== 11) {
                return false;
            }
            
            // Verifica se todos os dígitos são iguais
            if (/^(\d)\1{10}$/.test(cpf)) {
                return false;
            }
            
            // Validação do primeiro dígito verificador
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            let digitoVerificador1 = (resto < 2) ? 0 : resto;
            
            if (parseInt(cpf.charAt(9)) !== digitoVerificador1) {
                return false;
            }
            
            // Validação do segundo dígito verificador
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            let digitoVerificador2 = (resto < 2) ? 0 : resto;
            
            if (parseInt(cpf.charAt(10)) !== digitoVerificador2) {
                return false;
            }
            
            return true;
        }

        function formatarValidarCPF(campo) {
            const cpfFormatado = formatarCPF(campo.value);
            campo.value = cpfFormatado;
            
            const cpfStatus = document.getElementById('cpf-status');
            const erroCpf = document.getElementById('erro-cpf');
            
            // Remove apenas os números para validação
            const cpfNumeros = cpfFormatado.replace(/\D/g, '');
            
            if (cpfNumeros.length === 11) {
                if (validarCPF(cpfFormatado)) {
                    cpfStatus.textContent = '✓ CPF válido';
                    cpfStatus.className = 'cpf-status valid';
                    cpfStatus.style.color = 'green';
                    erroCpf.style.display = 'none';
                } else {
                    cpfStatus.textContent = '✗ CPF inválido';
                    cpfStatus.className = 'cpf-status invalid';
                    cpfStatus.style.color = 'red';
                }
            } else if (cpfNumeros.length > 0) {
                cpfStatus.textContent = '';
                cpfStatus.className = 'cpf-status';
                erroCpf.style.display = 'none';
            } else {
                cpfStatus.textContent = '';
                cpfStatus.className = 'cpf-status';
            }
        }

        function validarFormulario() {
            const senha1 = document.getElementById('senha').value;
            const senha2 = document.getElementById('senha2').value;
            const cpf = document.getElementById('cpf').value;
            const erroSenha = document.getElementById('erro-senha');
            const erroCpf = document.getElementById('erro-cpf');
            
            let formularioValido = true;
            
            // Validar senhas
            if (senha1 !== senha2) {
                erroSenha.style.display = 'block';
                formularioValido = false;
            } else {
                erroSenha.style.display = 'none';
            }
            
            // Validar CPF
            if (!validarCPF(cpf)) {
                erroCpf.style.display = 'block';
                formularioValido = false;
            } else {
                erroCpf.style.display = 'none';
            }
            
            return formularioValido;
        }
    </script>

    <style>
        .cpf-status {
            font-size: 12px;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .cpf-status.valid {
            color: green;
        }
        
        .cpf-status.invalid {
            color: red;
        }
        
        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
    </style>
</body>
</html>